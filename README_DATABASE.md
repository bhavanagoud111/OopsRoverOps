# Database Setup Guide

This project uses MySQL to persist mission reports and activity logs.

## Quick Start

### 1. Start MySQL with Docker

```bash
docker compose up -d mysql
```

**Note:** If you have Docker Compose v2 (default in newer Docker versions), use `docker compose` (with space). For older versions, use `docker-compose` (with hyphen).

This will:
- Start MySQL 8.0 in a container named `roverops-mysql`
- Create database `roverops_db`
- Create user `roverops_user` with password `roverops_password`
- Expose MySQL on port `3307` (host) â†’ `3306` (container) to avoid conflicts

### 2. Install Python Dependencies

```bash
cd backend
source venv/bin/activate
pip install -r requirements.txt
```

### 3. Initialize Database Tables

```bash
python scripts/init_db.py
```

Or from Python:

```python
from app.database.connection import init_db
init_db()
```

### 4. Configure Environment Variables

Copy `.env.example` to `.env` and update if needed:

```bash
cp .env.example .env
```

Default values (matching docker-compose.yml):
- `DB_HOST=localhost`
- `DB_PORT=3307`  # Note: Host port is 3307, container port is 3306
- `DB_USER=roverops_user`
- `DB_PASSWORD=roverops_password`
- `DB_NAME=roverops_db`

### 5. Start Backend

The backend will automatically:
- Check database connection on startup
- Initialize tables if they don't exist
- Save mission reports to database when generated

```bash
cd backend
source venv/bin/activate
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

## Database Schema

### Tables

1. **missions** - Mission metadata
   - `mission_id` (PK)
   - `goal`, `status`, `current_step`
   - `rover_final_x`, `rover_final_y`
   - `start_time`, `end_time`, `duration_seconds`
   - `created_at`, `updated_at`

2. **mission_steps** - Individual mission steps
   - `id` (PK)
   - `mission_id` (FK)
   - `step_number`, `action`, `target_x`, `target_y`
   - `description`, `completed`, `nasa_image_url`

3. **mission_logs** - Mission activity logs
   - `id` (PK)
   - `mission_id` (FK)
   - `timestamp`, `agent_type`, `message`
   - `level`, `data` (JSON)

4. **mission_obstacles** - Detected obstacles
   - `id` (PK)
   - `mission_id` (FK)
   - `x`, `y`, `detected_at`

5. **mission_reports** - Final mission reports
   - `id` (PK)
   - `mission_id` (FK, unique)
   - `summary`, `outcome`, `mission_status`
   - `completed_steps`, `total_steps`
   - `rover_final_x`, `rover_final_y`
   - `duration_seconds`
   - `collected_data` (JSON)
   - `mission_photos` (JSON)
   - `apod_data` (JSON)
   - `step_details` (JSON)

## Usage

### Saving Reports

Reports are automatically saved to the database when generated by the Reporter agent. No additional code needed.

### Retrieving Reports

The `/api/mission/{mission_id}/report` endpoint will:
1. Try to get report from database first
2. Fall back to in-memory mission state if not found

### Querying Logs

```python
from app.database.connection import get_db_context
from app.database.repository import MissionRepository

with get_db_context() as db:
    repo = MissionRepository(db)
    logs = repo.get_logs(mission_id, limit=100)
    for log in logs:
        print(f"{log.timestamp}: {log.agent_type} - {log.message}")
```

## Docker Commands

```bash
# Start MySQL
docker compose up -d mysql

# Stop MySQL
docker compose down

# View MySQL logs
docker compose logs mysql

# Connect to MySQL CLI
docker exec -it roverops-mysql mysql -u roverops_user -proverops_password roverops_db

# Backup database
docker exec roverops-mysql mysqldump -u roverops_user -proverops_password roverops_db > backup.sql

# Restore database
docker exec -i roverops-mysql mysql -u roverops_user -proverops_password roverops_db < backup.sql
```

## Troubleshooting

### Connection Failed

1. Check if MySQL container is running:
   ```bash
   docker ps | grep mysql
   ```

2. Check MySQL logs:
   ```bash
   docker-compose logs mysql
   ```

3. Verify environment variables match docker-compose.yml

### Tables Not Created

Run initialization script:
```bash
python backend/scripts/init_db.py
```

### Permission Issues

Ensure MySQL user has proper permissions:
```sql
GRANT ALL PRIVILEGES ON roverops_db.* TO 'roverops_user'@'%';
FLUSH PRIVILEGES;
```

